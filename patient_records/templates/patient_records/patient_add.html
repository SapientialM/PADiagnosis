{% extends 'index.html' %}
{% load static %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'patient_records:patient_list' %}">患者医学图像管理</a></li>
<li class="breadcrumb-item active" aria-current="page">新增患者图像</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title">新增患者图像</h2>
    </div>
    
    <!-- Django消息显示 -->
    {% if messages %}
    <div class="messages mb-4">
        {% for message in messages %}
        <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="row">
        <div class="col-md-8">
            <!-- 患者医学图像信息表单卡片 -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-gradient d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-image me-2"></i> 患者医学图像信息</span>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="patientAddForm">
                        {% csrf_token %}
                        
                        <!-- 患者医学图像信息 -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="image_style" class="form-label fw-semibold required">图像类别</label>
                                <select class="form-control form-control-sm" id="image_style" name="image_style" required>
                                    <option value="">请选择图像类别</option>
                                    <option value="CT">CT图像</option>
                                    <option value="MRI">MRI图像</option>
                                    <option value="X光">X光图像</option>
                                    <option value="超声">超声图像</option>
                                    <option value="其他">其他医学图像</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="patient_id" class="form-label fw-semibold required">患者ID</label>
                                <input type="text" class="form-control form-control-sm" id="patient_id" name="patient_id" placeholder="请输入患者ID" required>
                                <div class="form-text">请输入已存在的患者ID，用于关联患者基本信息</div>
                            </div>
                        </div>

                        <!-- 医学图像文件上传 -->
                        <div class="mt-4 pt-3 border-top">
                            <h5 class="card-title mb-3">
                                <i class="bi bi-file-earmark-image me-2 text-primary"></i>医学图像文件
                            </h5>
                            <div class="file-upload-container p-3 bg-light rounded">
                                <label for="medical_image" class="form-label fw-semibold required">上传医学图像文件</label>
                                <div class="input-group mb-2">
                                    <input class="form-control" type="file" id="medical_image" name="medical_image" accept=".nii.gz" required>
                                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#fileTemplateModal">
                                        <i class="bi bi-question-circle"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    <small>仅支持 .nii.gz 格式的医学图像文件（NIfTI压缩格式）。</small>
                                </div>
                                <div class="d-flex align-items-center mt-2">
                                    <div class="progress w-100 me-2" style="display: none;" id="uploadProgress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <span id="uploadStatus" class="text-muted small"></span>
                                </div>
                            </div>
                        </div>

                        <!-- 提交按钮 -->
                        <div class="d-flex justify-content-end mt-4">
                            <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="cancelButton">取消</button>
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="bi bi-save me-1"></i> 保存
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- 提示信息卡片 -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-info bg-gradient text-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-info-circle me-2"></i> 填写说明</span>
                </div>
                <div class="card-body">
                    <h6 class="card-subtitle mb-3 text-muted">如何填写患者医学图像信息</h6>
                    <ul class="small text-muted list-unstyled">
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i> 带 <span class="text-danger">*</span> 的字段为必填项</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i> 图像类别用于标识医学图像的类型和用途</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i> 患者ID必须为系统中已存在的患者</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i> 医学图像文件仅支持 .nii.gz 格式</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i> 请确保上传的图像文件完整且未损坏</li>
                    </ul>
                    
                    <div class="alert alert-warning mt-3 small">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>注意：</strong> 仅支持 .nii.gz 格式的医学图像文件，这是医学影像学中常用的NIfTI压缩格式。
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 文件格式说明模态框 -->
<div class="modal fade" id="fileTemplateModal" tabindex="-1" aria-labelledby="fileTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="fileTemplateModalLabel">医学图像文件格式说明</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>.nii.gz 格式说明：</strong></p>
                <div class="bg-light p-3 rounded border">
                    <ul class="mb-0">
                        <li><strong>NIfTI格式</strong>：Neuroimaging Informatics Technology Initiative，是医学影像学中广泛使用的标准格式</li>
                        <li><strong>压缩格式</strong>：.gz 表示使用gzip压缩，文件体积更小，传输更快</li>
                        <li><strong>支持软件</strong>：支持3D Slicer、ITK-SNAP、FSL、SPM等主流医学影像软件</li>
                        <li><strong>数据完整性</strong>：包含完整的3D空间信息和像素数据</li>
                    </ul>
                </div>
                <div class="alert alert-info mt-3 mb-0 small">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    系统仅支持 <strong>.nii.gz</strong> 格式的医学图像文件，请确保您的文件符合此格式要求。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 通知提示 -->
<div class="notification success" style="display: none;" id="successNotification">
    <i class="bi bi-check-circle"></i>
    <div>
        <h6 class="mb-0">操作成功</h6>
        <p class="mb-0 small">新患者图像已创建成功</p>
    </div>
    <button class="close-btn"><i class="bi bi-x"></i></button>
</div>

<div class="notification error" style="display: none;" id="errorNotification">
    <i class="bi bi-exclamation-circle"></i>
    <div>
        <h6 class="mb-0">操作失败</h6>
        <p class="mb-0 small" id="errorMessage">保存过程中发生错误</p>
    </div>
    <button class="close-btn"><i class="bi bi-x"></i></button>
</div>

<style>
.bg-gradient {
    background: linear-gradient(to right, #f8f9fa, #e9ecef);
}
.card {
    border-radius: 0.5rem;
    border: none;
}
.card-header {
    border-radius: 0.5rem 0.5rem 0 0 !important;
}
.file-upload-container {
    border: 1px dashed #dee2e6;
    transition: all 0.3s;
}
.file-upload-container:hover {
    border-color: #6c757d;
}
.form-label.required:after {
    content: ' *';
    color: red;
}
.is-invalid {
    border-color: #dc3545;
}
.invalid-feedback {
    display: none;
    color: #dc3545;
    font-size: 12px;
    margin-top: 0.25rem;
}
/* 修改placeholder文本颜色 */
::placeholder {
    color: #c0c0c0 !important;
    opacity: 0.7;
}
::-webkit-input-placeholder {
    color: #c0c0c0 !important;
    opacity: 0.7;
}
::-moz-placeholder {
    color: #c0c0c0 !important;
    opacity: 0.7;
}
:-ms-input-placeholder {
    color: #c0c0c0 !important;
    opacity: 0.7;
}
::-ms-input-placeholder {
    color: #c0c0c0 !important;
    opacity: 0.7;
}
</style>

{% block page_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('patientAddForm');
        const fileInput = document.getElementById('medical_image');
        const progressBar = document.querySelector('.progress-bar');
        const progressContainer = document.getElementById('uploadProgress');
        const uploadStatus = document.getElementById('uploadStatus');
        
        // 监听模态框隐藏事件，确保背景遮罩被完全清除
        const fileTemplateModal = document.getElementById('fileTemplateModal');
        if (fileTemplateModal) {
            fileTemplateModal.addEventListener('hidden.bs.modal', function () {
                // 移除可能残留的模态框背景
                const modalBackdrops = document.querySelectorAll('.modal-backdrop');
                modalBackdrops.forEach(backdrop => {
                    backdrop.remove();
                });
                
                // 移除body上的modal-open类
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            });
        }
        
        // 文件上传处理
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileName = file.name;
                const fileSize = (file.size / 1024).toFixed(2);
                
                // 检查文件格式
                if (fileName.endsWith('.nii.gz')) {
                    uploadStatus.textContent = `已选择: ${fileName} (${fileSize} KB)`;
                    uploadStatus.classList.add('text-success');
                    uploadStatus.classList.remove('text-danger');
                } else {
                    uploadStatus.textContent = `不支持的文件格式: ${fileName}，请选择.nii.gz格式文件`;
                    uploadStatus.classList.add('text-danger');
                    uploadStatus.classList.remove('text-success');
                    // 清空文件选择
                    fileInput.value = '';
                }
            } else {
                uploadStatus.textContent = '';
                uploadStatus.classList.remove('text-success', 'text-danger');
            }
        });
        
        // 表单验证
        form.addEventListener('submit', function(e) {
            let isValid = true;
            
            // 验证图像类别是否选择
            const imageStyle = document.getElementById('image_style').value;
            if (!imageStyle) {
                document.getElementById('image_style').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('image_style').classList.remove('is-invalid');
            }
            
            // 验证患者ID是否填写
            const patientId = document.getElementById('patient_id').value;
            if (!patientId) {
                document.getElementById('patient_id').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('patient_id').classList.remove('is-invalid');
            }
            
            // 如果验证失败，阻止表单提交
            if (!isValid) {
                e.preventDefault();
                return false;
            }
            
            // 检查文件是否已选择
            if (!fileInput.files[0]) {
                const errorNotification = document.getElementById('errorNotification');
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = '请选择医学图像文件';
                errorNotification.style.display = 'flex';
                e.preventDefault();
                return false;
            }
            
            // 检查文件格式是否为.nii.gz
            const fileName = fileInput.files[0].name;
            if (!fileName.endsWith('.nii.gz')) {
                const errorNotification = document.getElementById('errorNotification');
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = '仅支持.nii.gz格式的医学图像文件';
                errorNotification.style.display = 'flex';
                e.preventDefault();
                return false;
            }
            
            // 显示确认对话框
            if (!confirm('确定要提交该患者医学图像信息吗？')) {
                e.preventDefault();
                return false;
            }
            
            return true;
        });
        
        // 关闭通知
        const closeButtons = document.querySelectorAll('.notification .close-btn');
        closeButtons.forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.notification').style.display = 'none';
            });
        });

        // 取消按钮事件处理
        document.getElementById('cancelButton').addEventListener('click', function() {
            window.location.href = "{% url 'patient_records:patient_list' %}";
        });
    });
</script>
{% endblock %}
{% endblock %} 